---
- name: OpenStack Image Service (Controller)
  hosts: glance
  sudo: yes
  vars_files:
    - ../../program_vars/database_password
    - ../../program_vars/keystone_data
    - ../../program_vars/rabbitmq

  tasks:
    - name: ensure glance is installed
      apt: pkg={{item}} force=yes
      with_items:
        - glance
        - python-glanceclient
        - python-mysqldb
    
    - name: ensure glance sqlite is deleted
      file: >
          dest=/var/lib/glance/glance.sqlite
          state=absent

    - name: ensure glance-api.conf file is configured
      template: >
          src=files/glance-api.conf
          dest=/etc/glance/glance-api.conf
          owner=glance
          group=glance
          mode=0600
          backup=yes
      notify: restart glance-api

    - name: ensure glance-registry.conf file file is configured
      template: >
          src=files/glance-registry.conf
          dest=/etc/glance/glance-registry.conf
          owner=glance
          group=glance
          mode=0600
          backup=yes
      notify:
        - restart glance-registry

    - name: ensure keystone database is initialized
      command: /usr/bin/glance-manage db_sync
      #when: "ansible_hostname == primary_glance_host"
      notify:
        - restart glance-api
        - restart glance-registry
    
  handlers:
    - name: restart glance-api
      service: name=glance-api state=restarted

    - name: restart glance-registry
      service: name=glance-registry state=restarted
